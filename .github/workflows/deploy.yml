name: Deploy bantool runner

on:
  push:
    branches:
      - 'master'
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # keep the other jobs alive if one fails
      matrix:
        target: [cardkingdom, tcg_index, tcg_market]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install golang
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Show Go version
        run: go version

      - name: Cache Go module downloads
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod/cache
          key: go-mod-cache-${{ hashFiles('**/go.sum') }}
          restore-keys: go-mod-cache-

      - name: Build bantool
        run: |
          cd cmd/bantool
          go build -o bantool

      - name: Run bantool
        env:
          B2_KEY_ID: "${{ secrets.B2_KEY_ID }}"
          B2_APP_KEY: "${{ secrets.B2_APP_KEY }}"
          CK_PARTNER: "${{ vars.CK_PARTNER }}"
          TCG_PARTNER: "${{ vars.TCG_PARTNER }}"
          MTGJSON_TCGSKU_PATH: "${{ vars.MTGJSON_TCGSKU_PATH }}"
          TCGPLAYER_PUBLIC_ID: "${{ secrets.TCGPLAYER_PUBLIC_ID }}"
          TCGPLAYER_PRIVATE_ID: "${{ secrets.TCGPLAYER_PRIVATE_ID }}"
        run: |
          cd cmd/bantool
          ./bantool -mtgjson b2://mtgjsondata/AllPrintings.json.xz \
                    -output-path b2://mtgjsondata/${{ matrix.target }} \
                    -${{ matrix.target }}
